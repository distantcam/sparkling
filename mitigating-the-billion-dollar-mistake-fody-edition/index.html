<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta http-equiv="X-UA-Compatible" content="ie=edge"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-28399680-2"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-28399680-2")</script><link rel="alternate" type="application/rss+xml" title="Subscribe to What&#39;s New" href="/sparkling/feed.rss"><meta name="author" content="Cameron MacFarland"><link rel="apple-touch-icon" sizes="180x180" href="/sparkling/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/sparkling/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/sparkling/favicon-16x16.png"><link rel="manifest" href="/sparkling/site.webmanifest"><link rel="mask-icon" href="/sparkling/safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#2d89ef"><meta name="theme-color" content="#ffffff"><title>Mitigating The Billion Dollar Mistake - Fody Edition - Cam&#39;s Blog</title><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,700"><link rel="stylesheet" href="/sparkling/css/theme.css"><link rel="stylesheet" href="/sparkling/css/prism-xonokai.css" type="text/css">
<link rel="stylesheet" href="/sparkling/css/prism-line-numbers.css" type="text/css"></head><body><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a><nav class="navbar navbar-expand-md navbar-dark bg-dark"><div class="container px-0"><a class="navbar-brand" href="/sparkling/">Cam&#39;s Blog</a> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarCollapse"><ul class="navbar-nav ml-auto"><li class="nav-item"><a class="nav-link" href="/sparkling/">Home</a></li><li class="nav-item"><a class="nav-link" href="/sparkling/about">About</a></li><li class="nav-item"><a class="nav-link" href="/sparkling/tags">Tags</a></li><li class="nav-item"><a class="nav-link" href="/sparkling/feed.rss"><i class="fas fa-rss fa-lg"></i></a></li></ul></div></div></nav><div id="content"><div class="container mt-5"><div class="row"><main class="col-sm-12 col-md-8"><article><div class="blog-item-wrap"><img class="post-thumbnail" src="https://source.unsplash.com/ScEKf8u7y-c/750x410"><div class="post-inner-content"><header class="post-header"><h2 class="post-title">Mitigating The Billion Dollar Mistake - Fody Edition</h2><div class="post-meta"><span class="posted-on"><i class="fas fa-calendar-alt"></i> <time datetime="2013-01-08T16:00:00.000Z">9th January 2013</time> </span><span class="tags ml-2"><i class="fas fa-tags"></i> <a class="tag" href="/sparkling/tags/fody/">fody</a> <a class="tag" href="/sparkling/tags/aop/">aop</a></span></div></header><div class="post-content"><p><a href="http://haacked.com/articles/AboutHaacked.aspx" target="_blank" rel="noopener">Phil Haack</a> recently wrote a <a href="http://haacked.com/archive/2013/01/05/mitigate-the-billion-dollar-mistake-with-aspects.aspx" target="_blank" rel="noopener">post</a> in which he talked about protecting <abbr>C#</abbr> code from null references by automatically adding guard code. Phil’s implementation used PostSharp for the post compile injection. Instead I wanted to use Fody.</p><a id="more"></a><h3 id="Fody-vs-PostSharp"><a href="#Fody-vs-PostSharp" class="headerlink" title="Fody vs PostSharp"></a>Fody vs PostSharp</h3><p><a href="https://github.com/Fody/Fody/" target="_blank" rel="noopener">Fody</a> and <a href="http://www.sharpcrafters.com/" target="_blank" rel="noopener">PostSharp</a> are both post-compile tools that add extra code into your assembly. This is known as <a href="http://en.wikipedia.org/wiki/Aspect-oriented_programming" target="_blank" rel="noopener">Aspect Orientated Programming</a> and can be very useful for certain tasks.</p><p>PostSharp takes the approach of injecting generic hook code into your assembly, and then calling out to your aspect at runtime. Your aspect then runs, doing any code analysis and reflection at runtime to do it’s work. (This was my experience with PostSharp <abbr>V1</abbr> ages ago. Apparently you can do some reflection at compile time in <abbr>V2.1</abbr>, but not all of it. See the <a href="http://doc.sharpcrafters.com/postsharp-2.1/Default.aspx##PostSharp-2.1.chm/html/7480ca54-61c0-46c5-9914-60a58c3033e8.htm" target="_blank" rel="noopener">documentation</a>.) The final assembly still needs a reference to PostSharp, as well as any aspects you have added.</p><p>Also, for a simple 1 line method PostSharp produces this.</p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">// Note the [AllowNull] attribute is still in the code.</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">SomeMethod</span><span class="token punctuation">(</span><span class="token keyword">string</span> nonNullArg<span class="token punctuation">,</span> <span class="token punctuation">[</span>AllowNull<span class="token punctuation">]</span> <span class="token keyword">string</span> nullArg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    MethodExecutionArgs methodExecutionArgs <span class="token operator">=</span> 
        <span class="token keyword">new</span> <span class="token class-name">MethodExecutionArgs</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Arguments</span><span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token operator">></span>
        <span class="token punctuation">{</span>
            Arg0 <span class="token operator">=</span> nonNullArg<span class="token punctuation">,</span>
            Arg1 <span class="token operator">=</span> nullArg
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    MethodExecutionArgs arg_25_0 <span class="token operator">=</span> methodExecutionArgs<span class="token punctuation">;</span>
    MethodBase m <span class="token operator">=</span> SampleClass<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">></span>z__Aspects<span class="token punctuation">.</span>m15<span class="token punctuation">;</span>
    arg_25_0<span class="token punctuation">.</span>Method <span class="token operator">=</span> m<span class="token punctuation">;</span>
    SampleClass<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">></span>z__Aspects<span class="token punctuation">.</span>a3<span class="token punctuation">.</span><span class="token function">OnEntry</span><span class="token punctuation">(</span>methodExecutionArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>methodExecutionArgs<span class="token punctuation">.</span>FlowBehavior <span class="token operator">!=</span> FlowBehavior<span class="token punctuation">.</span>Return<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>nonNullArg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// NOTE: This is our original line.</span>
        SampleClass<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">></span>z__Aspects<span class="token punctuation">.</span>a3<span class="token punctuation">.</span><span class="token function">OnSuccess</span><span class="token punctuation">(</span>methodExecutionArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Not very clear at all!</p><p>In contrast, Fody extension only run at compile time. Fody uses <a href="http://www.mono-project.com/Cecil" target="_blank" rel="noopener">Mono.Cecil</a> to allow you to modify the <abbr>IL</abbr> before the Fody compile step writes the assembly back out. That assembly has no references to Fody, and the aspects are woven directly into the code. The problem with this approach is that you have to know <abbr>IL</abbr> in order to write your own Fody extension, whereas in PostSharp you just write a <abbr>.NET</abbr> assembly with the code you want executed at runtime.</p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">// Attribute removed from compiled code.</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">SomeMethod</span><span class="token punctuation">(</span><span class="token keyword">string</span> nonNullArg<span class="token punctuation">,</span> <span class="token keyword">string</span> nullArg<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nonNullArg <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token string">"nonNullArg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>nonNullArg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// NOTE: This is our original line.</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Much cleaner, and easier to understand what this code is doing.</p><h3 id="How-to-use-NullGuard"><a href="#How-to-use-NullGuard" class="headerlink" title="How to use NullGuard"></a>How to use NullGuard</h3><p>NullGuard is available via NuGet.</p><pre><code>PM&gt; Install-Package NullGuard.Fody
</code></pre><p>As an extension to Fody it will automatically include Fody as a dependency.</p><h2 id="Other-Extensions"><a href="#Other-Extensions" class="headerlink" title="Other Extensions"></a>Other Extensions</h2><p>There are a bunch of other extensions for Fody, so most of the time you won’t need to write a custom extension. You can find them by searching for ‘<a href="http://nuget.org/packages?q=fody" target="_blank" rel="noopener">Fody</a>‘ on NuGet.</p><p>Here are a few of my favourites.</p><ul><li><p><a href="https://github.com/Fody/PropertyChanging#readme" target="_blank" rel="noopener"><strong>PropertyChanging.Fody</strong></a> and <a href="https://github.com/Fody/PropertyChanged#readme" target="_blank" rel="noopener"><strong>PropertyChanged.Fody</strong></a> If you do any sort of <abbr>MVVM</abbr> development then these are a lifesaver! Automatically inserts <code>PropertyChanging</code> and <code>PropertyChanged</code> code into property setters. Never have to call <code>OnPropertyChanged()</code> ever again!</p></li><li><p><a href="https://github.com/Fody/ModuleInit#readme" target="_blank" rel="noopener"><strong>ModuleInit.Fody</strong></a> In <abbr>.NET</abbr> assemblies you can execute code when the assembly is loaded by putting it in a special class called <code>&lt;Module&gt;</code>. Unfortunately there is no way to access this class from <abbr>C#</abbr>. This extension allows you to write code that will execute when the <code>&lt;Module&gt;</code> is initialized.</p></li><li><p><a href="https://github.com/Fody/Validar#readme" target="_blank" rel="noopener"><strong>Validar.Fody</strong></a> Similar to PropertyChanged.Fody this injects code to automatically implement <code>IDataErrorInfo</code> and <code>INotifyDataErrorInfo</code>. Our ViewModels keep getting smaller and smaller!</p></li></ul></div></div></div></article><div id="comments"><h2 class="text-primary">x thoughts on “Mitigating The Billion Dollar Mistake - Fody Edition”</h2><ol class="comment-list"><li><div id="reply-0" class="comment-body"><div class="comment-meta"><div class="comment-author"><img width="60" height="60" src="https://www.gravatar.com/avatar/0d113e963c796ec77c7ed883e490316d?s=60&d=mp&r=g"> <b class="text-uppercase">Test Author</b></div><div class="comment-metadata"><time datetime="2019-02-24T13:27:34.103Z">24th February 2019 at 21:27:34</time></div></div><div class="comment-content"><p>Some comment</p></div><div class="reply text-right"><button class="reply btn btn-light-primary btn-sm" data-respondtarget="reply-0">Reply</button></div></div><ol class="children"><li><div id="reply-1" class="comment-body"><div class="comment-meta"><div class="comment-author"><img width="60" height="60" src="https://www.gravatar.com/avatar/2f5b3fa26595bc45871213860db4668f?s=60&d=mp&r=g"> <b class="text-uppercase">Anon User</b></div><div class="comment-metadata"><time datetime="2019-02-24T13:27:34.103Z">24th February 2019 at 21:27:34</time></div></div><div class="comment-content"><p>Anonymous reply</p></div><div class="reply text-right"><button class="reply btn btn-light-primary btn-sm" data-respondtarget="reply-1">Reply</button></div></div><ol class="children"><li><div id="reply-2" class="comment-body"><div class="comment-meta"><div class="comment-author"><img width="60" height="60" src="https://www.gravatar.com/avatar/2f5b3fa26595bc45871213860db4668f?s=60&d=mp&r=g"> <b class="text-uppercase">Anon User</b></div><div class="comment-metadata"><time datetime="2019-02-24T13:27:34.103Z">24th February 2019 at 21:27:34</time></div></div><div class="comment-content"><p>Third reply</p></div><div class="reply text-right"><button class="reply btn btn-light-primary btn-sm" data-respondtarget="reply-2">Reply</button></div></div></li></ol></li></ol></li><li><div id="reply-3" class="comment-body"><div class="comment-meta"><div class="comment-author"><img width="60" height="60" src="https://www.gravatar.com/avatar/0d113e963c796ec77c7ed883e490316d?s=60&d=mp&r=g"> <b class="text-uppercase">Test Author</b></div><div class="comment-metadata"><time datetime="2019-02-24T13:27:34.104Z">24th February 2019 at 21:27:34</time></div></div><div class="comment-content"><p>Some comment</p></div><div class="reply text-right"><button class="reply btn btn-light-primary btn-sm" data-respondtarget="reply-3">Reply</button></div></div></li></ol><div id="respond" class="comment-respond mb-4"><h6 class="text-uppercase text-primary">Leave a reply <small><a id="cancel-reply" href>Cancel reply</a></small></h6><form><small class="text-muted">Your email address will not be published. Required fields are marked <span class="text-primary">*</span></small> <input type="hidden" name="postId" value="mitigating-the-billion-dollar-mistake-fody-edition"><div class="form-group mt-2"><label for="inputComment">Comment</label> <textarea class="form-control" id="inputComment" rows="5"></textarea></div><div class="form-group mt-2"><label for="inputName">Name <span class="text-primary">*</span></label> <input type="name" class="form-control" id="inputName" aria-describedby="emailHelp" placeholder="required"></div><div class="form-group mt-2"><label for="inputEmail">Email <span class="text-primary">*</span></label> <input type="email" class="form-control" id="inputEmail" aria-describedby="emailHelp" placeholder="required"></div><button type="submit" class="btn btn-primary btn-sm text-uppercase">Post Comment</button></form></div></div></main><div class="col-sm-12 col-md-4"><div class="border bg-white p-4"><aside class="mb-5"><h6 class="text-uppercase">Follow us</h6><ul class="social-items"><li><a href="https://twitter.com/distantcam"><span class="fa-stack fa-lg"><i class="fas fa-square fa-stack-2x"></i> <i class="fab fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a href="https://github.com/distantcam"><span class="fa-stack fa-lg"><i class="fas fa-square fa-stack-2x"></i> <i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href="https://instagram.com/distantcam"><span class="fa-stack fa-lg"><i class="fas fa-square fa-stack-2x"></i> <i class="fab fa-instagram fa-stack-1x fa-inverse"></i></span></a></li><li><a href="https://stackoverflow.com/users/3820"><span class="fa-stack fa-lg"><i class="fas fa-square fa-stack-2x"></i> <i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i></span></a></li><li><a href="https://mastodon.social/@distantcam"><span class="fa-stack fa-lg"><i class="fas fa-square fa-stack-2x"></i> <i class="fab fa-mastodon fa-stack-1x fa-inverse"></i></span></a></li></ul></aside><aside class="mb-5"><h6 class="text-uppercase">Tags</h6><div class="mt-4"><a class="btn btn-light-primary btn-sm tag" href="/sparkling/tags/architecture/">architecture</a> <a class="btn btn-light-primary btn-sm tag" href="/sparkling/tags/mvvm/">mvvm</a> <a class="btn btn-light-primary btn-sm tag" href="/sparkling/tags/fody/">fody</a> <a class="btn btn-light-primary btn-sm tag" href="/sparkling/tags/aop/">aop</a> <a class="btn btn-light-primary btn-sm tag" href="/sparkling/tags/akavache/">akavache</a> <a class="btn btn-light-primary btn-sm tag" href="/sparkling/tags/etag/">etag</a> <a class="btn btn-light-primary btn-sm tag" href="/sparkling/tags/web/">web</a> <a class="btn btn-light-primary btn-sm tag" href="/sparkling/tags/cache/">cache</a> <a class="btn btn-light-primary btn-sm tag" href="/sparkling/tags/life/">life</a> <a class="btn btn-light-primary btn-sm tag" href="/sparkling/tags/c/">c#</a> <a class="btn btn-light-primary btn-sm tag" href="/sparkling/tags/language/">language</a> <a class="btn btn-light-primary btn-sm tag" href="/sparkling/tags/roslyn/">roslyn</a></div></aside></div></div></div></div></div><div class="scrolltop"><i class="fas fa-arrow-up"></i><span class="sr-only">Scroll to Top</span></div><footer><div class="container text-center"><ul class="social-items social-items-dark"><li><a href="https://twitter.com/distantcam"><span class="fa-stack fa-lg"><i class="fas fa-square fa-stack-2x"></i> <i class="fab fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a href="https://github.com/distantcam"><span class="fa-stack fa-lg"><i class="fas fa-square fa-stack-2x"></i> <i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href="https://instagram.com/distantcam"><span class="fa-stack fa-lg"><i class="fas fa-square fa-stack-2x"></i> <i class="fab fa-instagram fa-stack-1x fa-inverse"></i></span></a></li><li><a href="https://stackoverflow.com/users/3820"><span class="fa-stack fa-lg"><i class="fas fa-square fa-stack-2x"></i> <i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i></span></a></li><li><a href="https://mastodon.social/@distantcam"><span class="fa-stack fa-lg"><i class="fas fa-square fa-stack-2x"></i> <i class="fab fa-mastodon fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="text-muted">Copyright &copy; Cameron MacFarland 2012-2019</p></div></footer><script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script><script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script><script defer src="https://use.fontawesome.com/releases/v5.7.2/js/all.js" integrity="sha384-0pzryjIRos8mFBWMzSSZApWtPl/5++eIfzYmTgBBmXYdhvxPc+XcFEk+zJwDgWbP" crossorigin="anonymous"></script><script src="/sparkling/js/theme.js"></script></body></html>